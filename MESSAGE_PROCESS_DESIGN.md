# 信息处理的细化

这个系统需要满足外部信息接收器的要求，能够接收一批聊天信息并进行处理。
由于外部信息接收器的能力有限，他只能做到当店铺有新消息时，才会进入到该聊天窗口进行信息获取。并且只会获取所有的历史消息，并转发给我们。

另外，外部信息发送器在发送砍价/跟单任务的聊天信息时，会先通过我们创建会话以及聊天信息。每一个任务都会新建一个会话，并且会话的状态是ACTIVE。会话的类型是AUTO_BARGAIN或AUTO_FOLLOW_UP。

但同时，外部接收器也可能会接受到人工接管的会话，即不属于跟单/砍价任务的会话，这种时候需要

因此我们需要做到，当有外部接收器转发消息进来时，能够正确地处理这些消息，并且能够正确地创建会话或更新会话状态。

比方说：
情景1：
该店铺-账号组合之前没有记录过聊天信息，（意味着并未启动跟单或砍价任务），
此时接收到一批消息，需要提取最新的一组聊天信息，存储记录到一个新的会话里。
该会话需记录为人工接管的会话，状态为TRANSFERRED。并且企业微信发送提醒。

情景2：
该店铺-账号组合之前有记录过聊天信息，
此时接收到一批消息，需要判断是否存在ACTIVE/TRANSFERD状态的会话。
存在这两种状态会话意味着该店铺-账号组合正在处理某种任务，可能是机器人任务，也可能是人工接管的任务。

如果是ACTIVE状态的会话，则说明该店铺-账号组合正在进行跟单或砍价任务，此时需要更新会话状态和消息记录。

如果是TRANSFERRED状态的会话，则说明该店铺-账号组合正在进行人工接管的任务，此时需要更新会话状态和消息记录。并使用企业微信发送提醒。

情景3：
该店铺-账号组合之前有记录过聊天信息，
此时接收到一条消息，需要判断是否存在ACTIVE/TRANSFERD状态的会话。

如果没有会话处于上方状态，则需要创建一个新的会话，并记录为人工接管的会话，状态为TRANSFERRED。并使用企业微信发送提醒。

具体策略：
1. 首先检查是否有活跃的会话（状态为ACTIVE或TRANSFERRED）。
2. 如果没有活跃会话：
   - 创建一个新的会话，状态为TRANSFERRED。
   - 记录消息到新会话中。
   - 使用企业微信发送提醒。
3. 如果有活跃会话：
   - 检查会话状态：
        - 如果是ACTIVE状态:
            - 检查last_activity时间:
                - 如果超过一定时间（如30分钟），则更新会话状态为TIMEOUT，并创建新的会话，会话类型为人工（因为超时了）。
                - 如果未超过:
                    - 检查新聊天记录里 账号发送的消息里是否有非机器人消息
                        - 如果有，则更新会话状态为TRANSFERRED，并记录消息到会话中。并使用企业微信发送提醒。
                        - 如果没有，则更新会话消息记录。
        - 如果是TRANSFERRED状态，
            - 检查last_activity时间:
                - 如果超过一定时间 （如30分钟），则更新会话状态为TIMEOUT，并创建新的会话。
                - 如果未超过，则更新会话消息记录。并使用企业微信发送提醒。


