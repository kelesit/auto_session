# 聊天会话生命周期管理设计文档

## 1. 核心需求分析

### 1.1 业务目标
- **会话路由管理**: 为上游机器人任务（砍价、跟单等）提供安全的会话环境
- **人工介入机制**: 当需要人工处理时，能够及时转交给人工客服
- **会话隔离**: 机器人会话与人工会话相互独立，互不干扰
- **生命周期管理**: 为不同类型的任务提供完整的会话生命周期支持
- **冲突处理**: 智能处理会话冲突，确保系统稳定运行

### 1.2 系统定位
- **不实现具体任务逻辑**: 砍价、跟单等任务逻辑由上游系统实现
- **专注会话管理**: 提供会话的创建、路由、状态管理、转交等基础能力
- **支持外部集成**: 通过API为上游任务系统提供会话管理服务
- **人工介入桥梁**: 处理机器人任务需要转人工的场景
- **智能冲突处理**: 处理不同优先级会话之间的冲突场景

### 1.3 关键约束
- **单会话约束**: 同一账号-店铺下只能有一个活跃会话
- **优先级原则**: 人工客服会话优先级高于机器人会话
- **安全隔离**: 严格控制会话访问权限
- **人工自由**：只有机器人发送会话才会创建session，人工可以随时发起聊天，该会话系统无法及时记录

## 2. 会话类型设计

### 2.1 会话创建者分类
```
Human Session (人工会话)
├── MANUAL_CUSTOMER_SERVICE  # 人工客服
├── MANUAL_COMPLAINT        # 人工投诉处理
└── MANUAL_URGENT           # 人工紧急处理

Robot Session (机器人会话)  
├── AUTO_BARGAIN           # 自动砍价
└── AUTO_FOLLOW_UP         # 自动跟单
```

### 2.2 会话状态机
```
会话状态转换:
ACTIVE         -> COMPLETED        # 激活 -> 完成
ACTIVE         -> TRANSFERRED      # 激活 -> 转交人工
# ACTIVE         -> PAUSED           # 激活 -> 暂停
# PAUSED         -> ACTIVE           # 暂停 -> 恢复
# TRANSFERRED    -> COMPLETED        # 转交 -> 完成
ANY            -> CANCELLED        # 任何状态 -> 取消
ANY            -> TIMEOUT          # 任何状态 -> 超时
```

### 2.3 会话优先级定义
```
优先级层级:
1. EMERGENCY (紧急)     - MANUAL_URGENT
2. HIGH (高)           - MANUAL_CUSTOMER_SERVICE, MANUAL_COMPLAINT  
3. MEDIUM (中)         - AUTO_BARGAIN
4. LOW (低)            - AUTO_FOLLOW_UP
```

## 3. 生命周期管理策略

### 3.1 机器人会话生命周期（由上游系统驱动）

#### 3.1.1 砍价任务会话支持
```
阶段1: 会话创建
- 上游砍价系统请求创建 AUTO_BARGAIN 会话
- 检查冲突（是否有活跃会话）
- 如有冲突则返回失败，由上游决定重试策略
- 创建成功则返回会话ID

阶段2: 会话使用
- 上游系统通过会话ID发送消息
- 本系统负责消息路由和存储
- 监控会话活跃度和异常情况

阶段3: 会话结束
- 上游系统请求结束会话
- 更新会话状态为 COMPLETED
```

### 3.2 人工会话生命周期
```
阶段1: 接管/创建
- 人工主动创建会话

阶段2: 人工处理
- 完全由人工控制

阶段3: 结束
- 自动超时结束 (默认2小时)
- 释放会话资源
```

### 3.3 消息处理机制
```
外部消息批次处理流程:
1. 首先检查是否有活跃的会话（状态为ACTIVE或TRANSFERRED）。
2. 如果没有活跃会话：
   - 创建一个新的会话，状态为TRANSFERRED。
   - 记录消息到新会话中。
   - 使用企业微信发送提醒。
3. 如果有活跃会话：
   - 检查会话状态：
        - 如果是ACTIVE状态:
            - 检查last_activity时间:
                - 如果超过一定时间（如30分钟），则更新会话状态为TIMEOUT，并创建新的会话，会话类型为人工（因为超时了）。
                - 如果未超过:
                    - 检查新聊天记录里 账号发送的消息里是否有非机器人消息
                        - 如果有，则更新会话状态为TRANSFERRED，并记录消息到会话中。并使用企业微信发送提醒。
                        - 如果没有，则更新会话消息记录。
        - 如果是TRANSFERRED状态，
            - 检查last_activity时间:
                - 如果超过一定时间 （如30分钟），则更新会话状态为TIMEOUT，并创建新的会话。
                - 如果未超过，则更新会话消息记录。并使用企业微信发送提醒。

```

## 4. 会话优先级和冲突处理

### 4.1 优先级规则
```
优先级 (高 -> 低):
1. MANUAL_URGENT          # 紧急人工处理 (立即抢占)
2. MANUAL_CUSTOMER_SERVICE # 人工客服
3. MANUAL_COMPLAINT       # 人工投诉处理  
4. AUTO_BARGAIN          # 自动砍价
5. AUTO_FOLLOW_UP        # 自动跟单
```

### 4.2 冲突处理策略
```
情况1: 机器人会话进行中，检测到人工介入
处理: 将机器人会话转位人工会话

情况2: 人工会话进行中，机器人要求创建会话  
* 处理: 创建PENDING状态会话 -> 等待人工会话结束
处理: 机器人要求创建失败

情况3: 两个机器人任务冲突
* 处理: 按优先级决定 -> 高优先级执行 -> 低优先级等待
处理：先到先得，后的创建失败

```

### 4.3 会话转交机制
```
转交触发条件:
- 聊天记录中检测到人工介入
- 机器人任务异常需要人工介入

转交流程:
1. 添加新信息到现有会话
2. 转换会话状态为人工
3. 创建转交记录
4. 更新会话状态为 TRANSFERRED
5. 交接上下文数据给人工

转交数据包含:
- 会话历史消息
- 当前任务执行状态
- 转交原因和触发条件
```


### 第一阶段 (核心会话管理) - 1周
1. 扩展数据模型
   - 创建转交记录表
   - 创建外部任务关联表  
   - 创建操作日志表
   - 扩展会话表字段

2. 实现会话管理核心功能
   - 会话创建和冲突检测
   - 会话状态管理
   - 优先级处理

3. 实现消息处理机制
   - 消息批次处理
   - 消息去重
   - 会话关联逻辑

## 第二阶段 (API完善) - 1周  
1. FastAPI接口实现
   - RESTful API设计
   - 请求验证和错误处理

2. 转交机制实现
   - 转交流程管理
   - 人工通知系统集成
   - 上下文数据传递

3. 监控和告警
   - 指标收集
   - 告警规则配置
   - 健康检查接口

### 第三阶段 (集成优化) - 1周
1. 与上游任务系统集成测试
   - 接口联调
   - 压力测试
   - 容错测试

2. 性能优化和稳定性增强
   - 数据库优化
   - 缓存策略
   - 连接池配置

3. 监控指标和运维工具
   - 监控仪表板
   - 日志分析工具
   - 数据修复工具

